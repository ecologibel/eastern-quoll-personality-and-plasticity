---
title: "Personality and plasticity predicts post-release performance in a reintroduced mesopredator"
author: "Wilson B A, Evans M J, Gordon I J, Banks S C, Batson W G, Wimpenny C, Newport J & Manning A D"
date: "14 October 2021"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: united
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

<br />

# **1. Data preparation**

## **1.1 Behavioural assay data **

### **1.1.1 Scale variables**

During the behavioural assays of the 6 captive-bred and 7 wild-caught eastern quolls (*Dasyurus viverrinus*) in 2017, the following behavioural responses were measured:

  1. Latency to emerge (min) - `emerge`
  2. Latency to reach food (min) - `food`
  3. Time spent active - `active`
  4. Time spent vigilant - `vigil`
  5. Time spent hidden - `hid`
  6. Time spent exposed () - `out` 
  7. Giving-up density (%) - `gud`
  8. Number of camera triggers (n)
      + Total triggers - `trig` (not used)
      + Triggers in far half of enclosure - `trigpass` (used for analyses)

Because the enclosures were open to the elements, we needed to account for environmental stochasticity by adjusting our behavioural responses to these measures taken around the time of the assay (18:00 or 21:00) :

  1. Ambient temperature (Â°C) - `temp`
  2. Precipitation (mm) - `precip`
  3. Relative humidity (%) - `humid`
  4. Mean wind speed - `Wind`
  5. Pressure (hPa) - `press`
  6. Moon phase (%) - `moon`
  
Our first step is to the `scale()` all of these behavioural and environmental variables.

```{r, results='hide', warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(readxl)
library(magrittr)
library(lme4)

setwd("C:/Users/belsp/Google Drive/Academia/Australian National University/Projects/Eastern quoll/Behaviour/Data/R")
assay <- read_excel("behaviour data.xlsx", sheet="assay")
assay <- assay %>% mutate_at(c(11, 14:20, 26,28, 30:32, 34, 36:37), funs(c(scale(.))))
write.csv(assay, "assay.csv")
```

<br />

### **1.1.2 Predict behavioural responses**

Here, we model each quoll's behavioural response (`emerge`, `food`, `active`, `vigil`, `out`, `hid`, `gud`, and `trigpass`) including environmental measures, and predict their responses when these measures are accounted for. We then extract the model's intercept (personality) and slope (plasticity) coefficients for analyses.

```{r, results='hide', warning=FALSE, message=FALSE}
dependent <- c("emerge","food","active","vigil",
               "out","hid","gud","trigpass")
quolls <- levels(factor(assay$individual))
coefficients <- data.frame(individual=NULL, intercept=NULL, 
                           slope=NULL, variable=NULL)

for(v in 1:NROW(dependent)) {
  for(i in 1:NROW(quolls)){
    individual <- quolls[i]
    variable <- dependent[v]
    mod <- lm(eval(as.name(paste0(variable))) ~ 
                observation + temp + precip + humid + 
                wind + press + moon + cue + cycle + session,
              data=subset(assay, individual==quolls[i]))
    i <- coef(mod)[1]
    s <- coef(mod)[2]
    results <- data.frame(cbind(individual, i, s, variable))
    coefficients <- rbind(coefficients, results)
  }
}

coefficients <- reshape(coefficients, idvar="individual", 
                        timevar="variable", direction="wide")
names(coefficients) <- gsub("\\.", "_", names(coefficients))
coefficients <- coefficients[ , !duplicated(colnames(coefficients))]

post <- read_excel("behaviour data.xlsx", sheet="postrelease")
post <- left_join(post, coefficients, by="individual")
post <- post[ , !duplicated(colnames(post))]
write_csv(post, "postrelease.csv")
```

<br />

## **1.2 Post-release data** 

Here we calculate three of the dispersal-related post-release responses for each quoll in it's first 42 days post-release: `first_night`, `mean_dist`, and `hr95`.

<br />

### **1.2.1. First night distance**

Firstly, we calculate the distance each quoll travelled between its release site and its first daytime den.

```{r, results='hide', warning=FALSE, message=FALSE}
library(raster)
library(adehabitatHR)

post <- read_csv("postrelease.csv", col_types=cols())
rcoord <- data.frame(post$release_easting, post$release_northing)
fcoord <- data.frame(post$first_night_easting, post$first_night_northing)
post$first_dist <- pointDistance(rcoord, fcoord, lonlat=FALSE) #raster required
first_night <- post[c("individual", "first_dist")]
post <- left_join(first_night, post, by="individual") #dplyr required
post <- post[ , !duplicated(colnames(post))]
write.csv(post, "postr.csv", row.names=FALSE)
```

<br />

### **1.2.2 Mean distance between dens**

Next, we calculated the mean distance between each quoll's dens. This was calculated in [Wilson et al (2020)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0234455), and the data is available in [ANU Data Commons](https://datacommons.anu.edu.au/DataCommons/rest/display/anudc:6063?layout=def:display).

<br />

### **1.2.3 95% minimum convex polygon**

Finally, we calculated [95% MCPs](https://bit.ly/3lYGxxZ).

```{r, results='hide', warning=FALSE, message=FALSE}
den <- read_excel("behaviour data.xlsx", sheet="den")
den <- den[, c("Individual", "Easting", "Northing")]
post <- read.csv("postr.csv")

coordinates(den) <- c("Easting", "Northing") #create dataframe for coordinates
proj4string(den) <- CRS("+proj=utm +zone=55 +ellps=WGS84 +units=m +no_defs") #warnings okay
hr95 <- data.frame(mcp(den, percent=95)) #calculate MCP per individual (warnings okay)
names(hr95)[1] <- "individual"
post <- left_join(post, hr95, by="individual")
post <- mutate(post, hr95=area)
write_csv(post, "postr.csv")
```

<br />

# **2. Test behaviour by observation** 

## **2.1 Models** 

Here we model each of the behavioural responses against observation number, and extract the p-values for inclusion in composite scatterplots to come.

```{r, results='hide', warning=FALSE, message=FALSE}
library(ggplot2)
library(ggpubr)
```

```{r, warning=FALSE, message=FALSE}
assay <- read.csv("assay.csv")
dependent <- c("emerge","food","active","vigil", "out","hid","gud","trigpass")
pvalues <- data.frame(pvalue=NULL, variable=NULL)

mod <- lm(food ~ observation, 
               data=assay, na.action="na.fail")
summary(mod)

for(v in 1:NROW(dependent)) {
  variable <- dependent[v]
  mod <- lm(eval(as.name(paste0(variable))) ~ observation, 
               data=assay, na.action="na.fail")
  pvalue <- as.numeric(coef(summary(mod))[8])
  rsquared <- summary(mod)$r.squared
  fstatistic <- summary(mod)$fstatistic
  results <- data.frame(cbind(variable, fstatistic, rsquared, pvalue))
  pvalues <- rbind(pvalues, results)
  pvalues_observation <- subset(pvalues, fstatistic!=1 & fstatistic!=222)
}
pvalues_observation
```

<br />

## **2.2 Scatterplots** 

Here we plot each behavioural response against observation number to visualise the change in responses over the assay period.

```{r, warning=FALSE, message=FALSE}
assay <- read_excel("behaviour data.xlsx", sheet="assay")
xs <- c(14, 14, 14, 14, 14, 14, 14, 14)
ys <- c(110, 110, 19, 9, 26, 95, 90, 110)
variables <- c("emerge","food","active","vigil","out","hid","gud","trigpass")
names <- c("Latency to emerge (min)", "Latency to reach food (min)",
           "Time spent active (s)", "Time spent vigilant (s)",
          "Time spent exposed (s)", "Time spent hidden (s)",
          "Giving-up density (%)", "Number of camera triggers")
labels <- c("p < 0.01", "p = 0.01", "p = 0.954", "p < 0.01",
          "p = 0.306", "p = 0.306", "p < 0.01", "p = 0.307")

figs <- list()
for (i in 1:NROW(variables)) {
  loop_var = as.name(variables[i])
  figs[[i]] <- ggplot(data=assay, mapping=aes_string(x="observation", y=loop_var)) +
    geom_point(alpha=0.25) +
    geom_smooth(method="lm", color="black", fill="grey") +
    scale_x_continuous(name="Assay number") +
    scale_y_continuous(name=names[i]) +
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(), 
          panel.background=element_blank(),
          panel.border=element_blank(), 
          axis.line.x=element_line(color="grey"),
          axis.line.y=element_line(color="grey")) +
    annotate("text", x=xs[i], y=ys[i], label=labels[i])
}

regression <- ggarrange(plotlist=figs, heights=c(3,3,3,3), widths=c(3,3,3,3), 
                        font.label=list(size=10, face="bold", color="black"), ncol=4, 
                        nrow=2, label.x=0.89, label.y=0.99, hjust=-0.1, vjust=1.5)
regression
```

```{r, include=FALSE, eval=FALSE}
ggsave(filename="regressions.jpeg", regression, width=300, height=150, units="mm")
```

<br />

# **3. Correlation analysis**

Here we conduct a correlation analysis to compare each behavioural measure to every other behavioural measure, and visualise this in correlogram.

```{r, results='hide', warning=FALSE, message=FALSE}
#library(pacman)
library(corrplot)
library(RColorBrewer)
library(FactoMineR)
#library(factoextra)
#library(car)

post <- read.csv("postr.csv")
post <- subset(post, individual!="EQ25")
cor <- dplyr::select(post, 23:38) #intercept and slope for all responses
cor <- cor(cor) #correlation matrix

cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
```

```{r, warning=FALSE}
p.mat <- cor.mtest(cor)
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(cor, method="color", col=col(200), type="upper", 
         addCoef.col="black", tl.col="black", tl.srt=45, p.mat=p.mat, 
         sig.level=0.01, insig="blank", diag=FALSE, number.cex=0.6)
```

The correlation analysis revealed that time spent `out` (or exposed) was significantly correlated (R > 0.7) with:

  - Time spent `active` (time spent `out` - time spent `vigil`),
  - Time spent `hid` (total time - time spent `active` - `vigil`), and
  - Number of camera triggers ( or `trigpass`, a similar but independent response).

Time spent `out` created the most inter-individual variation, so the `active`, `hid`, and `trigpass` responses were dropped from futher analysis. 

<br />

# **4. Principle components analysis**

Next, we created PCA variables for the intercept and slope of each remaining behavioural response (`emerge`, `food`, `out`, `vigil`,and `gud`) by extracting the first dimension coordinates for each quoll.

```{r, results='hide', warning=FALSE, message=FALSE}
post <- read.csv("postr.csv")
post <- subset(post, individual!="EQ25")
individual <- c('EQ18','EQ19','EQ20','EQ21','EQ22','EQ23',
                'EQ24','EQ26','EQ27','EQ28','EQ29','EQ30','EQ31')

summary(PCA(post[,c(31,35)])) #proactive PCA for intercept
summary(PCA(post[,c(32,36)])) #proactive PCA for slope
summary(PCA(post[,c(23,25,29)])) #reactive PCA for intercept
summary(PCA(post[,c(24,26,30)])) #reactive PCA for slope

i_pro_pca <- get_pca_ind(PCA(post[,c(31,35)]))
i_pro_quoll <- data.frame(individual, i_pro_pca$coord)
i_pro_quoll <- dplyr::select(i_pro_quoll, 1,2)
i_pro_quoll <- rename(i_pro_quoll, i_pro_pca=Dim.1)

s_pro_pca <- get_pca_ind(PCA(post[,c(32,36)]))
s_pro_quoll <- data.frame(individual, s_pro_pca$coord)
s_pro_quoll <- dplyr::select(s_pro_quoll, 1,2)
s_pro_quoll <- rename(s_pro_quoll, s_pro_pca=Dim.1)

i_rea_pca <- get_pca_ind(PCA(post[,c(23,25,29)]))
i_rea_quoll <- data.frame(individual, i_rea_pca$coord)
i_rea_quoll <- dplyr::select(i_rea_quoll, 1,2)
i_rea_quoll <- rename(i_rea_quoll, i_rea_pca=Dim.1)

s_rea_pca <- get_pca_ind(PCA(post[,c(24,26,30)]))
s_rea_quoll <- data.frame(individual, s_rea_pca$coord)
s_rea_quoll <- dplyr::select(s_rea_quoll, 1,2)
s_rea_quoll <- rename(s_rea_quoll, s_rea_pca=Dim.1)

post_pca <- cbind(post, i_pro_quoll, s_pro_quoll, i_rea_quoll, s_rea_quoll, by="individual")
write.csv(post_pca, "post_pca.csv")
```

<br />

# **5. Test personality by post-release** 

Now that we have the intercept (personality) and slope (plasticity) of each of the six behavioural predictors (`emerge`, `food`, `out`, `vigil`, `gud`, and `pca`) we can model and plot them against our post-release responses:

  - Survival responses (n = 13)
    1. Fate (survived or died) - `fate`
    2. Post-release weight (%) - `weight`
    
  - Dispersal responses (for quolls that survived >7 days, n = 10, measured over 42 days)
    3. Number of dens used (n) - `dens_used`
    4. Mean distance travelled between dens per day (m) - `mean_dist`
    5. Days spent den sharing (n) - `den_shared_days`
    6. Home range (95% minimum convex polygon) - `hr95`

```{r, results='hide', warning=FALSE, message=FALSE}
library(tidyverse)
library(brglm)
library(ggplot2)

setwd("C:/Users/belsp/Google Drive/Academia/Australian National University/Projects/Eastern quoll/Behaviour/Data/R")
post <- read.csv("post_pca.csv")
dispersal <- subset(post, individual!="EQ20" & individual!="EQ29" & individual!="EQ30")
dispersal <- dispersal %>% mutate(hr95=as.numeric(hr95))
```

<br />

## **4.1 Fate** 

###  **4.1.1 Models**

```{r, results='hide', warning=FALSE, message=FALSE}
plotdat <- data.frame()
predictors <- c("emerge","food","vigil","out","gud","pro_pca","rea_pca")
labels <- c("Latency to emerge (min)", "Latency to reach food (min)",
               "Time spent vigilant (s)", "Time spent exposed (s)", 
               "Giving-up density (%)", "Proactive PC", "Reactive PC")

for (i in 1:7) {
  expr = as.formula(paste0("fate ~ i_",predictors[i]))
  mod <- brglm(expr, data=post, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)
    effect$label <- labels[i]
    effect$coefficient <- "Personality"
    effect$name <- row.names(effect)
  plotdat <- rbind(plotdat, effect)

  expr = as.formula(paste0("fate ~ s_",predictors[i]))
  mod <- brglm(expr, data=post, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)        
    effect$label <- labels[i]
    effect$coefficient <- "Plasticity"
    effect$name <- row.names(effect)
  plotdat <- rbind(plotdat, effect)
}

plotdat$lower <- plotdat$Estimate - (1.96*plotdat$Std..Error)
plotdat$upper <- plotdat$Estimate + (1.96*plotdat$Std..Error)
plotdat <- subset(plotdat,name!="(Intercept)")
plotdat$sig <- ifelse(plotdat$Pr...z..<0.05, "sig", "nonsig")

plotdat$label <- factor(plotdat$label, levels=c("Reactive PC", "Proactive PC", "Giving-up density (%)", 
                     "Time spent vigilant (s)", "Time spent exposed (s)", 
                     "Latency to reach food (min)", "Latency to emerge (min)"))

plot=ggplot(data=plotdat, aes(x=Estimate,y=label, xmin=lower, xmax=upper),
            ylab="", xlab="Effect size") + theme_bw()
```

<br />

###  **4.1.2 Plot**

```{r, warning=FALSE}
fig1 <- plot + ggtitle("Fate") +
  geom_vline(xintercept=0,linetype=3) +
  geom_errorbarh(height=0.25) +
  geom_point(stat="identity",aes(fill=factor(sig),size=sig), 
             shape=21, colour="black", alpha=1) +
  xlab("") + ylab("") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), panel.border=element_blank(),
        axis.line.x=element_line(), text=element_text(size=10,colour="black"),
        plot.title=element_text(hjust=0.5, size=10, face="bold"),
        axis.text.y=element_text(angle=0, vjust=0.5,colour="black"),
        axis.text.x=element_text(angle=0, vjust=0, hjust=0.5, colour="black"),
        axis.ticks.y=element_blank(), axis.title.y=element_text(size=12),
        axis.ticks.x=element_blank(), axis.title.x=element_blank(),
        legend.position="right", legend.justification="top",
        strip.background=element_blank()) +
  scale_size_manual(values=c("sig"=6, "nonsig"=2)) +
  scale_fill_manual(values=c("sig"="black", "nonsig"="white"),
                    name="", guide=guide_legend(reverse=TRUE)) +
  guides(alpha="none", group="none", colour="none", fill="none", size="none") +
  facet_grid(~coefficient, scales="free")
fig1
```

```{r, include=FALSE, eval=FALSE}
jpeg(filename="fate.jpeg", width=7000, height=4300, units="px",res=800)
fig1
dev.off()
```

<br />

## **4.2 Weight** 

###  **4.2.1 Models**

```{r, results='hide', warning=FALSE, message=FALSE}
plotdat <- data.frame()
predictors <- c("emerge","food","vigil","out","gud","pro_pca","rea_pca")
labels <- c("Latency to emerge (min)", "Latency to reach food (min)",
               "Time spent vigilant (s)", "Time spent exposed (s)", 
               "Giving-up density (%)", "Proactive PC", "Reactive PC")

for (i in 1:7) {
  expr = as.formula(paste0("pr_weight ~ i_",predictors[i]))
  mod <- glm(expr, data=post, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)
    effect$label <- labels[i]
    effect$coefficient <- "Personality"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)

  expr = as.formula(paste0("pr_weight ~ s_",predictors[i]))
  mod <- glm(expr, data=post, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)        
    effect$label <- labels[i]
    effect$coefficient <- "Plasticity"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)
}

plotdat$lower <- plotdat$Estimate - (1.96*plotdat$Std..Error)
plotdat$upper <- plotdat$Estimate + (1.96*plotdat$Std..Error)
plotdat <- subset(plotdat,name!="(Intercept)")
plotdat$sig <- ifelse(plotdat$Pr...t..<0.05, "sig", "nonsig")

plotdat$label <- factor(plotdat$label, levels=c("Reactive PC", "Proactive PC", "Giving-up density (%)", 
                     "Time spent vigilant (s)", "Time spent exposed (s)", 
                     "Latency to reach food (min)", "Latency to emerge (min)"))

plot=ggplot(data=plotdat, aes(x=Estimate,y=label, xmin=lower, xmax=upper),
            ylab="", xlab="Effect size") + theme_bw()
```

###  **4.2.2 Plot**

```{r, warning=FALSE}
fig2 <- plot + ggtitle("Post-release weight (%)")+
  geom_vline(xintercept=0,linetype=3) +
  geom_errorbarh(height=0.25) +
  geom_point(stat="identity",aes(fill=factor(sig),size=sig), 
             shape=21, colour="black", alpha=1) +
  xlab("") + ylab("") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), panel.border=element_blank(),
        axis.line.x=element_line(), text=element_text(size=10,colour="black"),
        plot.title=element_text(hjust=0.5, size=10, face="bold"),
        axis.text.y=element_text(angle=0, vjust=0.5,colour="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,colour="black"),
        axis.ticks.y=element_blank(), axis.title=element_text(size=12),
        axis.ticks.x=element_blank(), axis.title.x=element_blank(),
        legend.position="right", legend.justification="top",
        strip.background=element_blank()) +
  scale_size_manual(values=c("sig"=6, "nonsig"=2)) +
  scale_fill_manual(values=c("sig"="black", "nonsig"="white"),
                    name="", guide=guide_legend(reverse=TRUE)) +
  guides(alpha="none", group="none", colour="none", fill="none", size="none") +
  facet_grid(~coefficient, scales="free")
fig2
```

```{r, include=FALSE, eval=FALSE}
jpeg(filename="pr_weight.jpeg", width=7000, height=4300, units="px",res=800)
fig2
dev.off()
```

<br />

## **4.3 Number of dens used** 

###  **4.3.1 Models**

```{r, results='hide', warning=FALSE, message=FALSE}
plotdat <- data.frame()
predictors <- c("emerge","food","vigil","out","gud","pro_pca","rea_pca")
labels <- c("Latency to emerge (min)", "Latency to reach food (min)",
               "Time spent vigilant (s)", "Time spent exposed (s)", 
               "Giving-up density (%)", "Proactive PC", "Reactive PC")

for (i in 1:7) {
  expr = as.formula(paste0("dens_used ~ i_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)
    effect$label <- labels[i]
    effect$coefficient <- "Personality"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)

  expr = as.formula(paste0("dens_used ~ s_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)        
    effect$label <- labels[i]
    effect$coefficient <- "Plasticity"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)
}

plotdat$lower <- plotdat$Estimate - (1.96*plotdat$Std..Error)
plotdat$upper <- plotdat$Estimate + (1.96*plotdat$Std..Error)
plotdat <- subset(plotdat,name!="(Intercept)")
plotdat$sig <- ifelse(plotdat$Pr...t..<0.05, "sig", "nonsig")

plotdat$label <- factor(plotdat$label, levels=c("Reactive PC", "Proactive PC", "Giving-up density (%)", 
                     "Time spent vigilant (s)", "Time spent exposed (s)", 
                     "Latency to reach food (min)", "Latency to emerge (min)"))

plot=ggplot(data=plotdat, aes(x=Estimate,y=label, xmin=lower, xmax=upper),
            ylab="", xlab="Effect size") + theme_bw()
```

<br />

###  **4.3.2 Plot**

```{r, warning=FALSE}
fig3 <- plot + ggtitle("Number of dens used")+
  geom_vline(xintercept=0,linetype=3) +
  geom_errorbarh(height=0.25) +
  geom_point(stat="identity",aes(fill=factor(sig),size=sig), 
             shape=21, colour="black", alpha=1) +
  xlab("") + ylab("") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), panel.border=element_blank(),
        axis.line.x=element_line(), text=element_text(size=10,colour="black"),
        plot.title=element_text(hjust=0.5, size=10, face="bold"),
        axis.text.y=element_text(angle=0, vjust=0.5,colour="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,colour="black"),
        axis.ticks.y=element_blank(), axis.title=element_text(size=12),
        axis.ticks.x=element_blank(), axis.title.x=element_blank(),
        legend.position="right", legend.justification="top",
        strip.background=element_blank()) +
  scale_size_manual(values=c("sig"=6, "nonsig"=2)) +
  scale_fill_manual(values=c("sig"="black", "nonsig"="white"),
                    name="", guide=guide_legend(reverse=TRUE)) +
  guides(alpha="none", group="none", colour="none", fill="none", size="none") +
  facet_grid(~coefficient, scales="free")
fig3
```

```{r, include=FALSE, eval=FALSE}
jpeg(filename="dens_used.jpeg", width=7000, height=4300, units="px",res=800)
fig5
dev.off()
```

<br />

## **4.4 Mean distance between dens** 

###  **4.4.1 Models**

```{r, results='hide', warning=FALSE, message=FALSE}
plotdat <- data.frame()
predictors <- c("emerge","food","vigil","out","gud","pro_pca","rea_pca")
labels <- c("Latency to emerge (min)", "Latency to reach food (min)",
               "Time spent vigilant (s)", "Time spent exposed (s)", 
               "Giving-up density (%)", "Proactive PC", "Reactive PC")

for (i in 1:7) {
  expr = as.formula(paste0("mean_dist ~ i_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)
    effect$label <- labels[i]
    effect$coefficient <- "Personality"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)

  expr = as.formula(paste0("mean_dist ~ s_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)        
    effect$label <- labels[i]
    effect$coefficient <- "Plasticity"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)
}

plotdat$lower <- plotdat$Estimate - (1.96*plotdat$Std..Error)
plotdat$upper <- plotdat$Estimate + (1.96*plotdat$Std..Error)
plotdat <- subset(plotdat,name!="(Intercept)")
plotdat$sig <- ifelse(plotdat$Pr...t..<0.05, "sig", "nonsig")

plotdat$label <- factor(plotdat$label, levels=c("Reactive PC", "Proactive PC", "Giving-up density (%)", 
                     "Time spent vigilant (s)", "Time spent exposed (s)", 
                     "Latency to reach food (min)", "Latency to emerge (min)"))

plot=ggplot(data=plotdat, aes(x=Estimate,y=label, xmin=lower, xmax=upper),
            ylab="", xlab="Effect size") + theme_bw()
```

<br />

###  **4.4.2 Plot**

```{r, warning=FALSE}
fig4 <- plot + ggtitle("Mean distance between dens (m)")+
  geom_vline(xintercept=0,linetype=3) +
  geom_errorbarh(height=0.25) +
  geom_point(stat="identity",aes(fill=factor(sig),size=sig), 
             shape=21, colour="black", alpha=1) +
  xlab("") + ylab("") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), panel.border=element_blank(),
        axis.line.x=element_line(), text=element_text(size=10,colour="black"),
        plot.title=element_text(hjust=0.5, size=10, face="bold"),
        axis.text.y=element_text(angle=0, vjust=0.5,colour="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,colour="black"),
        axis.ticks.y=element_blank(), axis.title=element_text(size=12),
        axis.ticks.x=element_blank(), axis.title.x=element_blank(),
        legend.position="right", legend.justification="top",
        strip.background=element_blank()) +
  scale_size_manual(values=c("sig"=6, "nonsig"=2)) +
  scale_fill_manual(values=c("sig"="black", "nonsig"="white"),
                    name="", guide=guide_legend(reverse=TRUE)) +
  guides(alpha="none", group="none", colour="none", fill="none", size="none") +
  facet_grid(~coefficient, scales="free")
fig4
```

```{r, include=FALSE, eval=FALSE}
jpeg(filename="mean_dist.jpeg", width=7000, height=4300, units="px",res=800)
fig4
dev.off()
```

<br />

## **4.5 Days spent den sharing** 

**1. Models**

```{r, results='hide', warning=FALSE, message=FALSE}
plotdat <- data.frame()
predictors <- c("emerge","food","vigil","out","gud","pro_pca","rea_pca")
labels <- c("Latency to emerge (min)", "Latency to reach food (min)",
               "Time spent vigilant (s)", "Time spent exposed (s)", 
               "Giving-up density (%)", "Proactive PC", "Reactive PC")

for (i in 1:7) {
  expr = as.formula(paste0("den_shared_days ~ i_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)
    effect$label <- labels[i]
    effect$coefficient <- "Personality"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)

  expr = as.formula(paste0("den_shared_days ~ s_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)        
    effect$label <- labels[i]
    effect$coefficient <- "Plasticity"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)
}

plotdat$lower <- plotdat$Estimate - (1.96*plotdat$Std..Error)
plotdat$upper <- plotdat$Estimate + (1.96*plotdat$Std..Error)
plotdat <- subset(plotdat,name!="(Intercept)")
plotdat$sig <- ifelse(plotdat$Pr...t..<0.05, "sig", "nonsig")

plotdat$label <- factor(plotdat$label, levels=c("Reactive PC", "Proactive PC", "Giving-up density (%)", 
                     "Time spent vigilant (s)", "Time spent exposed (s)", 
                     "Latency to reach food (min)", "Latency to emerge (min)"))

plot=ggplot(data=plotdat, aes(x=Estimate,y=label, xmin=lower, xmax=upper),
            ylab="", xlab="Effect size") + theme_bw()
```

**2. Plot**

```{r, warning=FALSE}
fig5 <- plot + ggtitle("Days spent den sharing")+
  geom_vline(xintercept=0,linetype=3) +
  geom_errorbarh(height=0.25) +
  geom_point(stat="identity",aes(fill=factor(sig),size=sig), 
             shape=21, colour="black", alpha=1) +
  xlab("") + ylab("") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), panel.border=element_blank(),
        axis.line.x=element_line(), text=element_text(size=10,colour="black"),
        plot.title=element_text(hjust=0.5, size=10, face="bold"),
        axis.text.y=element_text(angle=0, vjust=0.5,colour="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,colour="black"),
        axis.ticks.y=element_blank(), axis.title=element_text(size=12),
        axis.ticks.x=element_blank(), axis.title.x=element_blank(),
        legend.position="right", legend.justification="top",
        strip.background=element_blank()) +
  scale_size_manual(values=c("sig"=6, "nonsig"=2)) +
  scale_fill_manual(values=c("sig"="black", "nonsig"="white"),
                    name="", guide=guide_legend(reverse=TRUE)) +
  guides(alpha="none", group="none", colour="none", fill="none", size="none") +
  facet_grid(~coefficient, scales="free")
fig5
```

```{r, include=FALSE, eval=FALSE}
jpeg(filename="den_shared_days.jpeg", width=7000, height=4300, units="px",res=800)
fig5
dev.off()
```

<br />

## **4.6 Home range** 

**1. Models**
  
```{r, results='hide', warning=FALSE, message=FALSE}
plotdat <- data.frame()
predictors <- c("emerge","food","vigil","out","gud","pro_pca","rea_pca")
labels <- c("Latency to emerge (min)", "Latency to reach food (min)",
               "Time spent vigilant (s)", "Time spent exposed (s)", 
               "Giving-up density (%)", "Proactive PC", "Reactive PC")

for (i in 1:7) {
  expr = as.formula(paste0("hr95 ~ i_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)
    effect$label <- labels[i]
    effect$coefficient <- "Personality"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)

  expr = as.formula(paste0("hr95 ~ s_",predictors[i]))
  mod <- glm(expr, data=dispersal, na.action="na.fail")
    effect <- data.frame(summary(mod)$coef)        
    effect$label <- labels[i]
    effect$coefficient <- "Plasticity"
    effect$name <- row.names(effect)
  plotdat <-rbind(plotdat, effect)
}

plotdat$lower <- plotdat$Estimate - (1.96*plotdat$Std..Error)
plotdat$upper <- plotdat$Estimate + (1.96*plotdat$Std..Error)
plotdat <- subset(plotdat,name!="(Intercept)")
plotdat$sig <- ifelse(plotdat$Pr...t..<0.05, "sig", "nonsig")

plotdat$label <- factor(plotdat$label, levels=c("Reactive PC", "Proactive PC", "Giving-up density (%)", 
                     "Time spent vigilant (s)", "Time spent exposed (s)", 
                     "Latency to reach food (min)", "Latency to emerge (min)"))

plot=ggplot(data=plotdat, aes(x=Estimate,y=label, xmin=lower, xmax=upper),
            ylab="", xlab="Effect size") + theme_bw()
```

**2. Plot**

```{r, warning=FALSE}
fig6 <- plot + ggtitle("Home range (95% MCP)")+
  geom_vline(xintercept=0,linetype=3) +
  geom_errorbarh(height=0.25) +
  geom_point(stat="identity",aes(fill=factor(sig),size=sig), 
             shape=21, colour="black", alpha=1) +
  xlab("") + ylab("") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
        panel.background=element_blank(), panel.border=element_blank(),
        axis.line.x=element_line(), text=element_text(size=10,colour="black"),
        plot.title=element_text(hjust=0.5, size=10, face="bold"),
        axis.text.y=element_text(angle=0, vjust=0.5,colour="black"),
        axis.text.x=element_text(angle=0, vjust=0.5,colour="black"),
        axis.ticks.y=element_blank(), axis.title=element_text(size=12),
        axis.ticks.x=element_blank(), axis.title.x=element_blank(),
        legend.position="right", legend.justification="top",
        strip.background=element_blank()) +
  scale_size_manual(values=c("sig"=6, "nonsig"=2)) +
  scale_fill_manual(values=c("sig"="black", "nonsig"="white"),
                    name="", guide=guide_legend(reverse=TRUE)) +
  guides(alpha="none", group="none", colour="none", fill="none", size="none") +
  facet_grid(~coefficient, scales="free")
fig6
```

```{r, include=FALSE, eval=FALSE}
jpeg(filename="hr95.jpeg", width=7000, height=4300, units="px",res=800)
fig6
dev.off()
```

<br />

## **4.7 Composite effect size plot** 

Finally, we combine the plots from 4.1 to 4.6 into a single composite figure.

```{r, results='hide', warning=FALSE, message=FALSE}
library(ggpubr)
library(gtools)
```

```{r, warning=FALSE}
effects <- ggarrange(fig1, fig2 + rremove("y.text"), 
                     fig3, fig4 + rremove("y.text"),
                     fig5, fig6 + rremove("y.text"), 
  heights=c(3,3,3),widths=c(4.5,3,3), ncol=2, nrow=3,
  font.label=list(size=10, face="bold", color ="black"),
  label.x=0.89, label.y=0.99, hjust=-0.1, vjust=1.5) 
effects <- annotate_figure(effects, 
                           bottom=text_grob("Effect size", hjust=-0.5))
effects
```

```{r, include=FALSE, eval=FALSE}
ggsave(filename="effects black.jpeg", effects, width=200, height=225, units="mm")
```
